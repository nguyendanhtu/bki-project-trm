CREATE PROCEDURE [dbo].[pr_V_GD_THANH_TOAN_GetThanhToanByGiangVien_thang_nam_dot_va_DVThanhToan]
@ID_GIANG_VIEN DECIMAL
,@ID_DON_VI_TT DECIMAL
,@ID_TRANG_THAI_TT DECIMAL
,@LOAI_HOP_DONG NVARCHAR(5)
,@REFERENCE_CODE NVARCHAR(50)
,@THANG_TT DECIMAL
,@NAM_TT DECIMAL
,@MA_DOT_THANH_TOAN NVARCHAR(250)
as
SELECT * FROM V_GD_THANH_TOAN vgtt
WHERE (vgtt.ID_GIANG_VIEN =@ID_GIANG_VIEN OR @ID_GIANG_VIEN=0)
AND (vgtt.LOAI_HOP_DONG = @LOAI_HOP_DONG OR @LOAI_HOP_DONG ='All')
AND vgtt.SO_PHIEU_THANH_TOAN IN (
	SELECT ddtt.MA_DOT_TT FROM DM_DOT_THANH_TOAN ddtt
	WHERE ddtt.ID_DON_VI_THANH_TOAN = @ID_DON_VI_TT OR @ID_DON_VI_TT =0)
AND (MONTH(vgtt.NGAY_THANH_TOAN) = @THANG_TT OR @THANG_TT =0)
AND (YEAR(vgtt.NGAY_THANH_TOAN) = @NAM_TT OR @NAM_TT =0)
AND  (vgtt.ID_TRANG_THAI_THANH_TOAN =@ID_TRANG_THAI_TT OR @ID_TRANG_THAI_TT = 0)
AND (vgtt.REFERENCE_CODE LIKE N'%'+@REFERENCE_CODE+'%' OR @REFERENCE_CODE ='')
AND (vgtt.SO_PHIEU_THANH_TOAN = @MA_DOT_THANH_TOAN OR @MA_DOT_THANH_TOAN = 'All')
ORDER BY vgtt.ID 

Go
-- 18/06/2012---
-- Alter view lập công việc cho GVCM
ALTER VIEW [dbo].[V_GD_GV_CONG_VIEC_MOI]
AS
SELECT
cvm.ID,
cvm.ID_HOP_DONG_KHUNG,
hdk.SO_HOP_DONG,
RTRIM(LTRIM(gv.HO_VA_TEN_DEM)) + ' ' + RTRIM(LTRIM(gv.TEN_GIANG_VIEN)) AS HO_VA_TEN_GIANG_VIEN,
cvm.ID_NOI_DUNG_TT,
ghdndt.NOI_DUNG_THANH_TOAN AS TEN_NOI_DUNG,
cvm.SO_LUONG_HE_SO,
cvm.SO_LUONG_NGHIEM_THU,
cvm.DON_GIA,
cvm.NGAY_DAT_HANG,
cvm.NGAY_NGHIEM_THU,
cvm.ID_TRANG_THAI,
cdtd.TEN AS TEN_TRANG_THAI,
cvm.ID_USER_NHAP,
nsd.TEN_TRUY_CAP,
cvm.GHI_CHU
FROM GD_GV_CONG_VIEC_MOI cvm, DM_HOP_DONG_KHUNG hdk, V_GD_HOP_DONG_NOI_DUNG_TT ghdndt,
	DM_GIANG_VIEN gv, HT_NGUOI_SU_DUNG nsd, CM_DM_TU_DIEN cdtd
where cvm.ID_HOP_DONG_KHUNG = hdk.ID
AND cvm.ID_NOI_DUNG_TT = ghdndt.ID
AND gv.ID = hdk.ID_GIANG_VIEN
AND nsd.ID = cvm.ID_USER_NHAP
AND cvm.ID_TRANG_THAI = cdtd.ID



GO
CREATE PROCEDURE pr_V_DM_GIANG_VIEN_Load_data_2_cbo
AS
SELECT * FROM DM_GIANG_VIEN dgv
WHERE dgv.ID IN
(SELECT DISTINCT dhdk.ID_GIANG_VIEN
   FROM GD_GV_CONG_VIEC_MOI ggcvm,DM_HOP_DONG_KHUNG dhdk
 WHERE ggcvm.ID_HOP_DONG_KHUNG = dhdk.ID)

Go

CREATE PROCEDURE pr_V_GD_GV_CONG_VIEC_MOI_Loc_Duyet_Ke_Hoach
	@ID_HOP_DONG_KHUNG DECIMAL,
	@ID_TRANG_THAI DECIMAL
AS
	SELECT * FROM V_GD_GV_CONG_VIEC_MOI cvm
	WHERE (cvm.ID_HOP_DONG_KHUNG = @ID_HOP_DONG_KHUNG OR @ID_HOP_DONG_KHUNG = 0)	
	AND (cvm.ID_TRANG_THAI = @ID_TRANG_THAI OR @ID_TRANG_THAI = 0)
GO

CREATE PROCEDURE [dbo].[pr_V_GD_GV_CONG_VIEC_MOI_Update]
	@ID numeric(18, 0),
	@ID_HOP_DONG_KHUNG numeric(18, 0),
	@SO_HOP_DONG NVARCHAR(100),
	@HO_VA_TEN_GIANG_VIEN NVARCHAR(101),
	@ID_NOI_DUNG_TT numeric(18, 0),
	@TEN_NOI_DUNG NVARCHAR(250),
	@SO_LUONG_HE_SO numeric(21, 3),
	@SO_LUONG_NGHIEM_THU NUMERIC(21,3),
	@DON_GIA numeric(21, 3),
	@NGAY_DAT_HANG datetime,
	@NGAY_NGHIEM_THU datetime,
	@ID_TRANG_THAI numeric(18, 0),
	@TEN_TRANG_THAI NVARCHAR(200),
	@ID_USER_NHAP numeric(18, 0),
	@TEN_TRUY_CAP NVARCHAR(50),
	@GHI_CHU nvarchar(250)
AS
UPDATE [dbo].[GD_GV_CONG_VIEC_MOI]
SET 
	[ID_HOP_DONG_KHUNG] = @ID_HOP_DONG_KHUNG,
	[ID_NOI_DUNG_TT] = @ID_NOI_DUNG_TT,
	[SO_LUONG_HE_SO] = @SO_LUONG_HE_SO,
	[SO_LUONG_NGHIEM_THU] = @SO_LUONG_NGHIEM_THU,
	[DON_GIA] = @DON_GIA,
	[NGAY_DAT_HANG] = @NGAY_DAT_HANG,
	[NGAY_NGHIEM_THU] = @NGAY_NGHIEM_THU,
	[ID_TRANG_THAI] = @ID_TRANG_THAI,
	[ID_USER_NHAP] = @ID_USER_NHAP,
	[GHI_CHU] = @GHI_CHU
WHERE
	[ID] = @ID

GO

CREATE PROCEDURE [dbo].[pr_V_DM_HOP_DONG_KHUNG_Load_data_2_cbo_by_Id_Giang_Vien]
@ID_GIANG_VIEN DECIMAL
AS
DECLARE @v_id_loai_hd_gvcm DECIMAL
SET @v_id_loai_hd_gvcm = (SELECT cdtd.ID
                            FROM CM_DM_TU_DIEN cdtd 
                          WHERE cdtd.ID_LOAI_TU_DIEN =5 AND cdtd.MA_TU_DIEN LIKE '%EDUTOP64_VH_GVCM%') 
SELECT * FROM DM_HOP_DONG_KHUNG dhdk
WHERE (dhdk.ID_GIANG_VIEN = @ID_GIANG_VIEN OR @ID_GIANG_VIEN = 0)
AND dhdk.ID_LOAI_HOP_DONG = @v_id_loai_hd_gvcm
AND dhdk.ID IN(SELECT DISTINCT ggcvm.ID_HOP_DONG_KHUNG
                 FROM GD_GV_CONG_VIEC_MOI ggcvm)
Go

CREATE PROCEDURE pr_V_DM_GIANG_VIEN_Load_data_2_cbo_CM
AS
SELECT * FROM DM_GIANG_VIEN dgv
WHERE dgv.GVCM_YN ='Y'
AND dgv.ID_TRANG_THAI_GIANG_VIEN = (SELECT ID FROM CM_DM_TU_DIEN cdtd
									 WHERE cdtd.ID_LOAI_TU_DIEN = 9 AND cdtd.MA_TU_DIEN LIKE '%DANG_CONG_TAC%')
ORDER BY dgv.HO_VA_TEN_DEM,dgv.TEN_GIANG_VIEN

Go
CREATE PROCEDURE pr_V_DM_HOP_DONG_KHUNG_Load_data_2_cbo_by_Id_Giang_Vien_CM_da_ky
@ID_GIANG_VIEN DECIMAL
AS
DECLARE @v_id_loai_hd_gvcm DECIMAL
DECLARE @v_id_trang_thai_hd_da_ky DECIMAL
SET @v_id_loai_hd_gvcm = (SELECT cdtd.ID
                            FROM CM_DM_TU_DIEN cdtd 
                          WHERE cdtd.ID_LOAI_TU_DIEN =5 AND cdtd.MA_TU_DIEN LIKE '%EDUTOP64_VH_GVCM%') 
SET @v_id_trang_thai_hd_da_ky = (SELECT cdtd.ID
                            FROM CM_DM_TU_DIEN cdtd 
                          WHERE cdtd.ID_LOAI_TU_DIEN =8 AND cdtd.MA_TU_DIEN LIKE '%DA_KY%')
SELECT * FROM DM_HOP_DONG_KHUNG dhdk
WHERE (dhdk.ID_GIANG_VIEN = @ID_GIANG_VIEN OR @ID_GIANG_VIEN = 0)
AND dhdk.ID_LOAI_HOP_DONG = @v_id_loai_hd_gvcm
AND dhdk.ID_TRANG_THAI_HOP_DONG = @v_id_trang_thai_hd_da_ky
ORDER BY dhdk.ID desc

Go
CREATE PROCEDURE [dbo].[pr_V_GD_GV_CONG_VIEC_MOI_Cap_Nhat_Trang_Thai]
	@ID_TRANG_THAI DECIMAL,
	@ID DECIMAL
AS
	UPDATE GD_GV_CONG_VIEC_MOI
	SET ID_TRANG_THAI = @ID_TRANG_THAI
	WHERE ID = @ID 

Go
